apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: platform
spec:
  serviceName: kafka
  replicas: 1
  podManagementPolicy: Parallel
  selector:
    matchLabels: { app: kafka }
  template:
    metadata:
      labels: { app: kafka }
    spec:
      containers:
        - name: broker
          image: docker.io/confluentinc/cp-kafka:7.6.1
          imagePullPolicy: Always
          ports:
            - { name: broker,     containerPort: 9092 }
            - { name: controller, containerPort: 9093 }
            - { name: internal,   containerPort: 29092 }
          env:
            - name: KAFKA_CFG_LISTENERS
              value: PLAINTEXT://:9092
            - name: KAFKA_CFG_ADVERTISED_LISTENERS
              value: PLAINTEXT://kafka.platform.svc.cluster.local:9092
            - name: KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP
              value: PLAINTEXT:PLAINTEXT
            - name: KAFKA_CFG_INTER_BROKER_LISTENER_NAME
              value: PLAINTEXT
            # REQUIRED by Confluent entrypoint, even if already formatted
            - { name: CLUSTER_ID, value: "MkU3OEVBNTcwNTJENDM2Qk" }  # any 22-char ID is fine
            # Single-node KRaft
            - { name: KAFKA_NODE_ID,               value: "1" }
            - { name: KAFKA_PROCESS_ROLES,         value: "broker,controller" }
            # Bind & advertise (pod FQDN)
            - { name: KAFKA_LISTENERS,             value: "CLIENT://:9092,CONTROLLER://:9093,INTERNAL://:29092" }
            - { name: KAFKA_ADVERTISED_LISTENERS,  value: "CLIENT://kafka-0.kafka.platform.svc.cluster.local:9092,INTERNAL://kafka-0.kafka.platform.svc.cluster.local:29092" }
            - { name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP, value: "CLIENT:PLAINTEXT,CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT" }
            - { name: KAFKA_INTER_BROKER_LISTENER_NAME,     value: "INTERNAL" }
            - { name: KAFKA_CONTROLLER_LISTENER_NAMES,      value: "CONTROLLER" }
            - { name: KAFKA_CONTROLLER_QUORUM_VOTERS,       value: "1@kafka-0.kafka.platform.svc.cluster.local:9093" }
            # MVP conveniences
            - { name: KAFKA_AUTO_CREATE_TOPICS_ENABLE,               value: "true" }
            - { name:  KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE, value: "true" }
            - { name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR,        value: "1" }
            - { name: KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR, value: "1" }
            - { name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR,           value: "1" }
          readinessProbe:
            tcpSocket: { port: 9092 }
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 12
          volumeMounts:
            - { name: data, mountPath: /var/lib/kafka/data }
      volumes:
        - { name: data, emptyDir: {} }  # swap to PVC later
