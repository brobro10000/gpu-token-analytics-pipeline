apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-create-topics
  namespace: platform
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        app: kafka-create-topics
    spec:
      restartPolicy: OnFailure
      containers:
        - name: topic-create
          image: docker.io/confluentinc/cp-kafka:7.6.1
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash","-ec"]
          args:
            - |
              BS="kafka.platform.svc.cluster.local:9092"

              echo "[wait] for broker to be reachable..."
              for i in $(seq 1 60); do
                if /usr/bin/kafka-topics --bootstrap-server "$BS" --list >/dev/null 2>&1; then
                  echo "[ok] broker is reachable"
                  break
                fi
                echo "[retry] broker not ready ($i/60)"; sleep 2
              done

              echo "[create] topics (idempotent)"
              /usr/bin/kafka-topics --create --if-not-exists --topic gpu.metrics.v1  --partitions 1 --replication-factor 1 --bootstrap-server "$BS" || true
              /usr/bin/kafka-topics --create --if-not-exists --topic token.usage.v1 --partitions 1 --replication-factor 1 --bootstrap-server "$BS" || true

              echo "[list]"
              /usr/bin/kafka-topics --bootstrap-server "$BS" --list
